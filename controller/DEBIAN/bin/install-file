#!/usr/bin/env python

import os
import sys
import time

from palapi import UpgradeHandler, UpgradeException

class Upgrade(object):

    def __init__(self):

        # State of the controller and its upgrade mode.
        self.state_upgrade = False

        try:
            self.comm = UpgradeHandler()

            if self.comm.verbose:
                if self.comm.console:
                    print 'Doing console upgrade'
                elif self.comm.target_dir:
                    print 'Doing non-console upgrade'
                else:
                    print 'Nothing to do.'
                    sys.exit(3)

            if not os.path.exists(self.comm.newfile):
                self.error("No such file: %s" % self.comm.newfile)

            checksum = self.comm.checksum(self.comm.newfile)
            if self.comm.verbose:
                print "checksum of %s: %s" % (self.comm.newfile, checksum)

            self.comm.send_cmd("upgrade on")
    
            self.state_upgrade = True

            filename_only = os.path.basename(self.comm.newfile)
            filename_only_tmp = filename_only + '.download'
    
            agent = self.comm.get_agent_info()

            if self.comm.console:
                target_dir = agent['path'].join(agent['install_dir'],
                                                            'upgrade')
            elif self.comm.target_dir:
                target_dir = self.comm.target_dir
            else:
                self.error("Nothing to do.")

            target_path_tmp = agent['path'].join(target_dir,
                                                        filename_only_tmp)
            target_path = agent['path'].join(target_dir, filename_only)

            self.comm.send_cmd("file listdir '%s'" % target_dir)
            files = self.comm.result['files']

            if filename_only_tmp in files:
                self.comm.send_cmd("file delete '%s'" % target_path_tmp)

            # order: file put <dest> <source>
            self.comm.send_cmd("file put '%s' '%s'" % (target_path_tmp,
                                                        self.comm.newfile))

            self.comm.send_cmd("file sha256 '%s'" % target_path_tmp)
            if not 'hash' in self.comm.result:
                self.error(\
                    "sha256 command on file '%s' failed.  Missing 'hash': %s",
                        target_path_tmp, result)

            agent_checksum = self.comm.result['hash']

            if checksum != agent_checksum:
                self.error(\
                    "Checksum on controller (%s) didn't match agent (%s)." % \
                        (checksum, agent_checksum))

                self.comm.send_cmd("file delete '%s'" % target_path_tmp)
                            
            if filename_only in files:
                # Delete the old one before moving the old one to its location
                self.comm.send_cmd("file delete '%s'" % target_path)

            # order: file move <src> <dest>
            self.comm.send_cmd("file move '%s' '%s'" % (target_path_tmp,
                                                            target_path))

            time.sleep(1)   # Give time to finish
            if self.comm.console:
                self.comm.send_cmd("hup")

                # We don't need to do an "upgrade off" if the console
                # agent was upgraded, since the agent has exited.
                if self.comm.verbose:
                    print "Primary Agent Upgrade was successful."
                sys.exit(0)

            self.comm.send_cmd("upgrade off")

            if self.comm.verbose:
                print "File Upgrade was successful."

        except UpgradeException, e:
            self.error(e)

            self.upgrade_back()

        except KeyboardInterrupt:
            print "\nInterrupted.  Exiting."

            self.upgrade_back()

    def upgrade_back(self):
        if self.state_upgrade:
            try:
                self.comm.send_cmd("upgrade off")
            except UpgradeException, e:
                print >> sys.stderr, "%s: %s" % (sys.argv[0], e)

    def error(self, msg):
        print >> sys.stderr, "%s: %s" % (sys.argv[0], msg)

        self.upgrade_back()

        sys.exit(2)

if __name__ == "__main__":
    Upgrade()
