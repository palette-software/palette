#!/usr/bin/env python

import os
import sys

from palapi import UpgradeHandler, UpgradeException

class Upgrade(object):

    def __init__(self):

        # State of the controller and its update mode.
        self.state_update = False

        comm = UpgradeHandler()

        if comm.verbose:
            if comm.console:
                print 'Doing console update'
            elif comm.target_dir:
                print 'Doing non-console update'
            else:
                print 'Nothing to do.'
                sys.exit(3)

        if not os.path.exists(comm.newfile):
            self.error("No such file: %s" % comm.newfile)

        checksum = comm.checksum(comm.newfile)
        if comm.verbose:
            print "checksum of %s: %s:" % (comm.newfile, checksum)

        try:
            comm.send_cmd("update on")
    
            self.state_update = True

            filename_only = os.path.basename(comm.newfile)
            filename_only_tmp = filename_only + '.download'
    
            agent = comm.get_agent_info()

            if comm.console:
                target_dir = agent['install_dir']
            elif comm.target_dir:
                target_dir = comm.target_dir
            else:
                self.error("Nothing to do.")

            target_path_tmp = agent['path'].join(target_dir,
                                                        filename_only_tmp)
            target_path = agent['path'].join(target_dir, filename_only)
    
            # order: file put <dest> <source>
            comm.send_cmd("file put '%s' '%s'" % (target_path_tmp,
                                                        comm.newfile))

            """
            comm.send_cmd("file sha256 '%s'" % target_path_tmp)
            agent_checksum = result['stdout']

            if checksum != agent_checksum:
                self.error(\
                    "Checksum on controller (%s) didn't match agent (%s)." % \
                        checksum, agent_checksum)
    

            # order: file move <src> <dest>
            comm.send_cmd("file move '%s' '%s'" % (target_path_tmp,
                                                            target_path))

            if comm.console:
                comm.send_cmd("hup")
                if result['stdout'] != 'OK':
                    self.error("HUP failed.")

            """
            comm.send_cmd("update off")

        except UpgradeException, e:
            self.error(e)

            self.update_back()

        except KeyboardInterrupt:
            print "\nInterrupted.  Exiting."

            self.update_back()

    def update_back(self):
        if self.state_update:
            comm.send_cmd("update off")

    def error(self, msg):
        print >> sys.stderr, "%s: %s" % (sys.argv[0], msg)

        self.update_back()

        sys.exit(2)

if __name__ == "__main__":
    Upgrade()
