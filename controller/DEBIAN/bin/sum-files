#!/usr/bin/env python

# pylint: disable=invalid-name
# Prints the sha256 sum of all files in the agent's Palette install-dir.

import os
import sys

#pylint: disable=import-error
from controller.palapi import CommHandlerArgs, CommException

class SumFiles(object):

    def __init__(self):

        # Sets up the parser with required arguments.
        self.comm = CommHandlerArgs()
        self.comm.parse_args()

        try:
            agent = self.comm.get_agent_info()
            install_dir = agent['path'].join(agent['install-dir'])

            self.comm.send_cmd("file listdir '%s'" % install_dir)
            files = self.comm.result['files']

            for fname in files:
                full_path = os.path.join(install_dir, fname)

                self.comm.send_cmd("file sha256 '%s'" % full_path)
                if not 'hash' in self.comm.result:
                    self.error(("sha256 command on file '%s' failed.  " + \
                               "Missing 'hash': %s") %
                               (full_path, self.comm.result))
                print self.comm.result['hash'], ' ', fname

        except CommException as ex:
            self.error(ex)

        except KeyboardInterrupt:
            print "\nInterrupted.  Exiting."

    def error(self, msg):
        print >> sys.stderr, "%s: %s" % (sys.argv[0], msg)

        sys.exit(2)

if __name__ == "__main__":
    SumFiles()
